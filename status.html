<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Status</title>
  <link rel="icon" type="image/x-icon" href="logo t.png">
  <link rel="stylesheet" href="style.css">
  <script type="module" src="script.js"></script>
  <style>
    /* ---------- RESULT GRID ---------- */
    .orders-grid {display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
   
    .order-status-card {
      display:flex;
      padding:16px;
      border-radius:12px;
      background:var(--card);
      border:1px solid var(--glass-border);
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      gap:16px;
      align-items:flex-start;
    }

    /* ---------- STATUS (LEFT) ---------- */
    .order-status-left {
      flex: 0 0 140px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .status-circle {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.75rem;
      color: white;
      flex-shrink: 0;
    }
    /* Status Colors */
    .status-green { background: #4caf50; }
    .status-red { background: #d32f2f; }
    .status-grey { background: #9ca3af; }

    /* ---------- MIDDLE (DETAILS) ---------- */
    .order-status-middle {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.95rem;
    }
    .muted { color: var(--muted); }
    .price-line { font-weight: 600; color: var(--accent); }

    /* ---------- RIGHT (STATUS INDICATOR) ---------- */
    .order-status-right {
      flex: 0 0 140px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-end;
      font-weight: 600;
      font-size: 1rem;
    }
    .final-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .final-status.green {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }
    .final-status.red {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }
    .final-status-icon {
      font-weight: bold;
      font-size: 1.1rem;
    }

    /* ---------- CANCELLED STATE ---------- */
    .order-cancelled .status-item { color: #9ca3af !important; }
    .order-cancelled .status-circle { background: #9ca3af !important; }

    /* Responsive */
    @media (max-width: 768px) {
      .order-status-card { flex-direction: column; }
      .order-status-left, .order-status-right { flex: none; align-items: flex-start; }
      .order-status-right { align-items: flex-end; margin-top: 12px; }
    }
  </style>
</head>
<body>
<!-- [Header, Form, Notice, Footer – unchanged] -->
<header class="site-header">
  <nav>
    <a href="index.html" class="logo"><img src="logo.png" alt="Logo" style="height:40px;"></a>
    <div class="nav-links">
      <a href="index.html">Products</a>
      <a href="status.html">Order Status</a>
      <a href="admin.html">Admin</a>
    </div>
  </nav>
</header>
<div class="container">
  <h1>Order Status</h1>
  <form id="status-form" class="form">
    <div>
      <label>Phone Number</label>
      <input id="phone-input" type="tel" placeholder="e.g. 01XXXXXXXXX" required>
    </div>
    <button type="submit">Check Orders</button>
  </form>
  <div id="order-result" class="order-result"></div>
</div>

<!-- [Notice & Footer – unchanged] -->
<!-- ... (your notice section and footer here) ... -->

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getFirestore, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
  import { firebaseConfig } from './config.js';

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const statusOrder = ['Pending', 'Processing', 'Dispatched', 'Delivered', 'Cancelled'];

  document.getElementById('status-form').addEventListener('submit', async e => {
    e.preventDefault();
    const phone = document.getElementById('phone-input').value.trim();
    if (!phone) return;

    const result = document.getElementById('order-result');
    result.innerHTML = '<p style="text-align:center;color:var(--muted);">Loading...</p>';
    result.classList.add('show');

    try {
      const q = query(collection(db, 'orders'), where('phone', '==', phone), orderBy('timeISO', 'desc'));
      const snap = await getDocs(q);
      result.innerHTML = '';
      if (snap.empty) {
        result.innerHTML = `<p style="text-align:center;color:var(--muted);">No orders for ${phone}</p>`;
        return;
      }

      const prodSnap = await getDocs(collection(db, 'products'));
      const prodMap = {};
      prodSnap.docs.forEach(d => { prodMap[d.id] = d.data(); });

      const grid = document.createElement('div');
      grid.className = 'orders-grid';

      snap.docs.forEach(doc => {
        const order = doc.data();
        const product = prodMap[order.productId] || {};
        const isPreOrder = product.availability === 'Pre Order';
        const delivery = isPreOrder ? '20–40 days' : '2–5 days';
        const avail = isPreOrder ? 'Pre-Order' : 'In Stock';
        const curStat = order.status;
        const curIdx = statusOrder.indexOf(curStat);
        const cancelled = curStat === 'Cancelled';

        const card = document.createElement('div');
        card.className = `card order-status-card ${cancelled ? 'order-cancelled' : ''}`;

        // Build left status items (progress bar)
        let statusHTML = '';
        statusOrder.forEach((st, i) => {
          const isCurrent = i === curIdx;
          const isCompleted = i < curIdx && !cancelled;
          const isCancelled = st === 'Cancelled' && cancelled;
          let icon = '';
          let colorClass = 'status-grey';
          if (isCancelled) {
            icon = '✗';
            colorClass = 'status-red';
          } else if (isCompleted || (isCurrent && st !== 'Cancelled')) {
            icon = '✓';
            colorClass = 'status-green';
          } else {
            icon = '';
          }
          statusHTML += `
            <div class="status-item" style="color:${isCancelled ? '#ef4444' : isCompleted || (isCurrent && !cancelled) ? '#22c55e' : '#9ca3af'};">
              <div class="status-circle ${colorClass}">${icon}</div>
              <span>${st}</span>
            </div>`;
        });

        // Right-side final status with Checkmark/Crossmark and colored background
        const isActiveStatus = ['Pending', 'Processing', 'Dispatched', 'Delivered'].includes(curStat);
        const statusColorClass = cancelled ? 'red' : 'green';
        const statusIcon = cancelled ? '✗' : '✓';

        card.innerHTML = `
          <!-- Status on Left -->
          <div class="order-status-left">
            ${statusHTML}
          </div>
          <!-- Middle: Product Details -->
          <div class="order-status-middle">
            <div><strong>${order.productName}</strong></div>
            <div class="muted">Color: ${order.color || '—'}</div>
            <div class="muted">Quantity: ${order.quantity}</div>
            <div class="price-line">
              Paid: ৳${order.paid}
              ${order.due > 0 ? `<span class="due"> (Due: ৳${order.due})</span>` : ''}
            </div>
            <div class="muted">${avail}</div>
            <div class="muted">Est. Delivery: <strong>${delivery}</strong></div>
            <div class="muted">Ordered on: ${new Date(order.timeISO).toLocaleDateString()}</div>
          </div>
          <!-- Right: Final Status with Icon + Text -->
          <div class="order-status-right">
            <div class="final-status ${statusColorClass}">
              <span class="final-status-icon">${statusIcon}</span>
              <span>${curStat}</span>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      result.appendChild(grid);
    } catch (err) {
      console.error(err);
      const url = err.message.match(/https:\/\/[^\s]+/)?.[0];
      result.innerHTML = url
        ? `<p style="color:var(--danger);">Index missing! <a href="${url}" target="_blank" style="color:blue;">Fix here</a></p>`
        : `<p style="color:var(--danger);">Error: ${err.message}</p>`;
    }
  });
</script>
</body>
</html>
